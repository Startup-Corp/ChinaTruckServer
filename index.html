<script>
  // Корзина хранится в localStorage
  let cart = JSON.parse(localStorage.getItem("cart")) || [];

  // Функция для добавления товара в корзину и сохранения состояния в localStorage
  function addToCart(productId, productName, productPrice, productQuantity) {
    const existingProductIndex = cart.findIndex(
      (item) => item.id === productId
    );

    if (existingProductIndex !== -1) {
      cart[existingProductIndex].quantity = productQuantity;
    } else {
      cart.push({
        id: productId,
        name: productName,
        price: productPrice,
        quantity: productQuantity,
      });
    }
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartCount();
  }

  // Функция для удаления товара из корзины и обновления localStorage
  function removeFromCart(productId) {
    cart = cart.filter((item) => item.id !== productId);
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartCount();
  }

  // Массив для хранения продуктов
  let products = [];
  let currentPage = 1;
  const itemsPerPage = 18;

  // Функция для получения данных с сервера
  async function fetchProducts(page, searchTerm = '') {
    try {
      const response = await fetch(`http://localhost:8000/read_excel?page=${page}&limit=${itemsPerPage}&search=${searchTerm}`);
      if (!response.ok)
        throw new Error(`HTTP error! status: ${response.status}`);

      const text = await response.text();
      console.log("Response Text:", text);

      // Проверяем, что ответ содержит валидный JSON
      products = JSON.parse(text);
      if (!Array.isArray(products))
        throw new Error("Received data is not an array.");

      if (searchTerm) {
        displayProducts(); // Отображаем товары только если есть поисковый запрос
      } else {
        clearProducts(); // Скрываем товары, если поисковый запрос пустой
      }
    } catch (error) {
      console.error("Ошибка получения данных:", error);
    }
  }

  // Функция для очистки отображения товаров
  function clearProducts() {
    const productsContainer = document.querySelector(".products");
    productsContainer.innerHTML = "";
  }

  function updateCartCount() {
    const cartElement = document.getElementById("n-add16a4a-e991-4fd9-ae56-70e63b675187");
    if (cartElement) {
      // Подсчитываем общее количество товаров в корзине
      const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);

      if (totalCount > 0) {
        // Устанавливаем атрибут data-count для отображения числа
        cartElement.setAttribute("data-count", totalCount);
        // Добавляем класс для отображения кружка
        cartElement.classList.add("cart-with-count");
      } else {
        // Убираем атрибут и класс, если корзина пуста
        cartElement.removeAttribute("data-count");
        cartElement.classList.remove("cart-with-count");
      }
    }
  }

  // Функция для отображения товаров и восстановления состояния кнопок и количества из localStorage
  async function displayProducts() {
    const productsContainer = document.querySelector(".products");
    productsContainer.innerHTML = "";

    products.forEach((product) => {
      const productCard = document.createElement("div");
      productCard.classList.add("product-card");

      const isAvailable = product.Примечание == "в наличии";
      const priceText =
        product.Цена >= 0 ? `${product.Цена} ₽` : "Цена уточняется";

      console.log(product.articul);
      // Запрос на получение изображения
      let imageUrl = "3.JPG"; // Путь к изображению-заглушке

      async function getImageUrl() {
        const url = `/files/images/${product.articul}.jpg`;

        try {
          const response = await fetch(url);
          if (response.ok) {
            return url;
          }
        } catch (error) {
          console.warn(
            `Изображение для артикула ${product.articul} не найдено по адресу ${url}.`
          );
        }

        return imageUrl; // Используем заглушку, если изображение не найдено
      }

      getImageUrl().then((url) => {
        imageUrl = url;

        productCard.innerHTML = `
      <div class="product-image-wrapper">
        <img src="${imageUrl}" alt="${
          product.name || "Нет названия"
        }" class="product-image">
      </div>
      <h3 class="product-title" title = "${product.name}">${product.name || "Нет названия"}</h3>
      <div class="product-footer">
        <p class="product-description" title = "${product.articul}">Артикул: ${
          product.articul || "Нет артикула"
        }</p>
        <p class="product-count">${isAvailable ? "В наличии" : "Под заказ"}</p>

        <div class="product-price-and-button">
          <p class="product-price">${
            isAvailable ? `Цена: ${priceText}` : "Нет товара"
          }</p>
          <button class="buy-button" data-id="${product.articul}" data-name="${
          product.name
        }" data-price="${product.Цена}" ${isAvailable ? "" : "disabled"}>
            Купить
          </button>
        </div>

        <div class="quantity-wrapper" style="display: none;">
          <button class="quantity-button minus">-</button>
          <input type="number" class="quantity-input" min="1" value="1" max="${
            product.Цена
          }" readonly>
          <button class="quantity-button plus">+</button>
        </div>
      </div>
    `;

        productsContainer.appendChild(productCard);

        const buyButton = productCard.querySelector(".buy-button");
        const quantityWrapper = productCard.querySelector(".quantity-wrapper");
        const quantityInput = productCard.querySelector(".quantity-input");

        buyButton.addEventListener("click", () => {
          if (buyButton.textContent === "В корзине") {
            window.location.href = "/payment";
            return;
          }

          const productId = buyButton.getAttribute("data-id");
          const productName = buyButton.getAttribute("data-name");
          const productPrice = parseFloat(buyButton.getAttribute("data-price"));
          const selectedQuantity = parseInt(quantityInput.value, 10);

          addToCart(productId, productName, productPrice, selectedQuantity);

          buyButton.textContent = "В корзине";
          buyButton.style.backgroundColor = "#3c3d4a";
          quantityWrapper.style.display = "flex";
        });

        const minusButton = productCard.querySelector(".minus");
        const plusButton = productCard.querySelector(".plus");

        minusButton.addEventListener("click", () => {
          let currentValue = parseInt(quantityInput.value, 10);
          if (currentValue > 1) {
            quantityInput.value = currentValue - 1;
            addToCart(
              buyButton.getAttribute("data-id"),
              buyButton.getAttribute("data-name"),
              parseFloat(buyButton.getAttribute("data-price")),
              currentValue - 1
            );
          } else {
            quantityWrapper.style.display = "none";
            buyButton.textContent = "Купить";
            buyButton.style.backgroundColor = "#ff6347";
            buyButton.disabled = false;
            removeFromCart(buyButton.getAttribute("data-id"));
          }
        });

        plusButton.addEventListener("click", () => {
          let currentValue = parseInt(quantityInput.value, 10);
          quantityInput.value = currentValue + 1;
          addToCart(
            buyButton.getAttribute("data-id"),
            buyButton.getAttribute("data-name"),
            parseFloat(buyButton.getAttribute("data-price")),
            currentValue + 1
          );
        });
      });
    });

    // Восстанавливаем состояние кнопок и количества после полной отрисовки продуктов
    loadButtonState();
    updateCartCount();
  }

  // Функция для загрузки состояния кнопок и количества товаров из localStorage
  function loadButtonState() {
    cart.forEach((item) => {
      // Ищем карточку товара по ID в корзине
      const buyButton = document.querySelector(
        `.buy-button[data-id="${item.id}"]`
      );

      // Если кнопка не найдена, пропускаем текущий элемент
      if (!buyButton) return;

      const productCard = buyButton.closest(".product-card");
      if (productCard) {
        const quantityWrapper = productCard.querySelector(".quantity-wrapper");
        const quantityInput = quantityWrapper.querySelector(".quantity-input");

        // Обновляем состояние кнопки и количества
        buyButton.textContent = "В корзине";
        buyButton.style.backgroundColor = "#3c3d4a";
        buyButton.disabled = false;
        quantityWrapper.style.display = "flex";
        quantityInput.value = item.quantity;
      }
    });
  }

  // Функция дебаунс для оптимизации ввода
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  document.querySelector(".search-input").addEventListener("input", debounce(function (event) {
      const searchTerm = event.target.value ? event.target.value.toLowerCase().trim() : "";
      currentPage = 1; // Сброс на первую страницу при новом поиске
      if (searchTerm) {
        fetchProducts(currentPage, searchTerm);
      } else {
        clearProducts(); // Скрываем товары, если поисковый запрос пустой
      }
  }, 300));

  // Метод для перехода к следующей странице
  function nextPage() {
    currentPage++;
    const searchTerm = document.querySelector(".search-input").value.toLowerCase().trim();
    fetchProducts(currentPage, searchTerm);
  }

  // Метод для перехода к предыдущей странице
  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      const searchTerm = document.querySelector(".search-input").value.toLowerCase().trim();
      fetchProducts(currentPage, searchTerm);
    }
  }

  // Привязка обработчиков событий к кнопкам
  document.getElementById("next-page").addEventListener("click", nextPage);
  document.getElementById("prev-page").addEventListener("click", prevPage);

  // Загрузка состояния кнопок при загрузке страницы
  document.addEventListener("DOMContentLoaded", () => {
    // fetchProducts(currentPage); // Загружаем продукты и сразу отображаем их
    updateCartIndicator();
  });
</script>
